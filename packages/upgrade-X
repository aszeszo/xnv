#!/bin/ksh93

###
# Copyright 2009 Sun Microsystems, Inc.  All rights reserved.
# Use is subject to license terms.
#
# Permission is hereby granted, free of charge, to any person obtaining a
# copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, and/or sell copies of the Software, and to permit persons
# to whom the Software is furnished to do so, provided that the above
# copyright notice(s) and this permission notice appear in all copies of
# the Software and that both the above copyright notice(s) and this
# permission notice appear in supporting documentation.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT
# OF THIRD PARTY RIGHTS. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
# HOLDERS INCLUDED IN THIS NOTICE BE LIABLE FOR ANY CLAIM, OR ANY SPECIAL
# INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES WHATSOEVER RESULTING
# FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
# NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
# WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
#
# Except as contained in this notice, the name of a copyright holder
# shall not be used in advertising or otherwise to promote the sale, use
# or other dealings in this Software without prior written authorization
# of the copyright holder.
#
###########################################################################
#
#
# Description: This script upgrades X software on a Solaris Nevada
#	       system. It should be run as root from a X package area.
#
# Arguments:	-a 	Ignored (was: install ALL packages, which is now the
#			default behaviour.)
#		-q	Be quiet and don't report packages that aren't 
#			installed.
#		-r	Remove packages only, and don't add new ones.
#			(Useful for removing newer build before going back to
#			 an older one with fewer/different packages)
#		-R path	Install under alternate root path (passed to pkgadd)
#
###

# Update this when X package version number changes
XVERS="6.9.0.5.11"

# Set up error reporting function
progname="$0"

function fatal_error
{
    print -u2 "${progname}: ERROR: $*"
    exit 1
}

####
#
#   Process command line options
#
####

QUIET=0
ALTROOT=""
REMOVE_ONLY=0
ACTION='upgrade'

while getopts aqrR: flag ; do
    case $flag in
      a)	;;
      q)	QUIET=1 ;;
      r)	REMOVE_ONLY=1 ; ACTION='removal' ;;
      R)	ALTROOT="${OPTARG}" ;;
      ?)	printf "Usage: %s: [-q]\n"  $0
		exit 1 ;;
    esac
done

ADDITIONAL_PKG_FLAGS=""
if [[ ! -z "${ALTROOT}" ]] ; then
    ADDITIONAL_PKG_FLAGS+="-R ${ALTROOT}"
fi

# Make sure directories that are needed, but not included in pkgmaps
# are created in alternate roots.
# Arguments: directory_path permissions owner:group
function altroot_dir_check
{
    if [[ ( ! -z "${ALTROOT}" ) && ( ! -d "${ALTROOT}$1" ) ]] ; then
	print "Creating ${ALTROOT}$1"
	mkdir -p "${ALTROOT}$1"
	chown $3 "${ALTROOT}$1"
	chmod $2 "${ALTROOT}$1"
    fi
}

altroot_dir_check / root:root 0755

###
#  
#   First check for a correct upgrade environment. 
#
###

MACH="$(uname -p)"

DATE="$(LANG=C date '+%d%b%y-%H:%M:%S')"

USER="$(/bin/id | grep root | wc -l)"
if [[ $USER -eq 0 ]] ; then
    fatal_error "You must be root to run this script"
fi

X_BASE_PKG=SUNWxwplt/pkginfo

if [[ -f ${X_BASE_PKG} ]]; then
    X_ARCH="$(awk -F= '$1 == "ARCH" {print $2}' ${X_BASE_PKG})"
    X_VERSION="$(awk -F= '$1 == "SUNW_PRODVERS" {print $2}' ${X_BASE_PKG})"
    X_BUILD="$(nawk '/^VERSION=/ {FS="[,.]+" ; print $(NF-4)/100}' ${X_BASE_PKG})"
else
v    fatal_error "Cannot find base X package -- SUNWxwplt\n" \ 
	"You need to run this script from the X ${XVERS} package area"
fi

if [[ "${X_ARCH}" != "${MACH}" ]]; then
    fatal_error "SUNWxwplt package has wrong architecture (${X_ARCH}).\n" \
	"It should have a ${MACH} architecture string."
fi

if [[ -z "${X_VERSION}" ]]; then
    fatal_error "Cannot find SUNWxwplt package version.\n" \
	"It should have a X ${XVERS} version string."
else
    if [[ "${X_VERSION}" != "${XVERS}" ]]; then
	fatal_error "SUNWxwplt package has wrong version (${X_VERSION}).\n" \
	    "It should have a X ${XVERS} version string."
    fi
fi

if [[ ( -z "${ALTROOT}" ) && ( "$(uname -r)" != "5.11" ) ]] ; then
    fatal_error "Incorrect Solaris version number.\n" \
	"X ${XVERS} is only supported on Solaris Nevada"
fi

if [[ -f /usr/bin/pkg ]] ; then
    if /usr/bin/pkg ${ADDITIONAL_PKG_FLAGS} list SUNWxwplt > /dev/null 2>&1 ; then
	fatal_error "Cannot run on system with IPS installed X packages."
    fi
fi

PKG_UPGRADE_LOG="${ALTROOT}/var/tmp/SunSoft_X${XVERS}_B${X_BUILD}_upgrade.log.${DATE}"
altroot_dir_check /var 0755 root:sys
altroot_dir_check /var/tmp 1777 root:sys

####
#
#   List of packages to upgrade
#
####

# List of official (deliverable) X Consolidation packages for all platforms
# and all supported builds/releases 
# Packages needed to be able to run mkfontdir come first, since later packages
# will need them - those are SUNWfreetype2 & SUNWxwfsw.   The rest are listed
# in alphabetical order.
pkg_list="
	SUNWfreetype2
	SUNWxwfsw
	SUNWxwfnt
	SUNWfontconfig 
	SUNWfontconfig-root
	SUNWfontconfig-docs 
	SUNWfont-daewoo-misc
	SUNWfont-isas-misc
	SUNWfont-jis-misc
	SUNWfont-misc-ethiopic
	SUNWfont-misc-meltho
	SUNWfont-xorg-cyrillic
	SUNWfont-xorg-core
	SUNWfont-xorg-iso8859-1
	SUNWfont-xorg-iso8859-2
	SUNWfont-xorg-iso8859-3
	SUNWfont-xorg-iso8859-4
	SUNWfont-xorg-iso8859-5
	SUNWfont-xorg-iso8859-7
	SUNWfont-xorg-iso8859-8
	SUNWfont-xorg-iso8859-9
	SUNWfont-xorg-iso8859-10
	SUNWfont-xorg-iso8859-11
	SUNWfont-xorg-iso8859-13
	SUNWfont-xorg-iso8859-14
	SUNWfont-xorg-iso8859-15
	SUNWfont-xorg-iso8859-16
	SUNWpciaccess
	SUNWpixman
	SUNWsynergy
	SUNWttf-bh-luxi
	SUNWttf-bitstream-vera
	SUNWttf-dejavu
	SUNWttf-google-droid
	SUNWttf-liberation
	SUNWvncviewer
	SUNWxcompmgr
	SUNWxcursor-themes
	SUNWxdm-root
	SUNWxdm
	SUNWxorg-client-docs
	SUNWxorg-client-programs
	SUNWxorg-clientlibs
	SUNWxorg-compatlinks
	SUNWxorg-graphics-ddx
	SUNWxorg-headers
	SUNWxorg-mesa
	SUNWxorg-server
	SUNWxorg-tsol-module
	SUNWxvnc
	SUNWxwacx
	SUNWxwcft
	SUNWxwdem
	SUNWxwdxm
	SUNWxwfs
	SUNWxwice
	SUNWxwinc
	SUNWxwman
	SUNWxwmod
	SUNWxwoft
	SUNWxwopt
	SUNWxwplr
	SUNWxwplt
	SUNWxwpmn
	SUNWxwrtl
	SUNWxwslb
	SUNWxwxft
"

####
#
#   Deal with changes since various older Nevada builds
#
####        

# Packages to remove because they are obsolete and not being replaced
REM_PKGS=""

# snv_46: 6261914 Removal of STSF & Xst [PSARC 2006/087]
REM_PKGS+=" SUNWstsf SUNWstsfr SUNWxwxst"

# snv_91: 6699573 CDE Font Administration Tools removal [LSARC 2008/010]
REM_PKGS+=" SUNWxwfa"

# snv_97: 6731942 Remove SUNWxwsrc package
REM_PKGS+=" SUNWxwsrc"

# snv_98: 6741034 Merge SUNWi1of into SUNWxwfnt
REM_PKGS+=" SUNWi1of"

# snv_107: 6582489 X11R7.4: Xorg server 1.5.3 and associated driver updates
# Merged SUNWxorg-doc into SUNWxorg-server & SUNWxorg-graphics-ddx
REM_PKGS+=" SUNWxorg-doc"

# snv_108: 6798225 stop building/delivering SUNWxwdim
REM_PKGS+=" SUNWxwdim"

# snv_111: 6815064 Merge SUNWxwhl into SUNWxwinc
REM_PKGS+=" SUNWxwhl"

# snv_116: 6840423 merge SUNWxorg-devel-docs into SUNWxwpmn, 
#	   6826940 remove SUNWxorg-cfg (Xorg 1.6 upgrade)
REM_PKGS+=" SUNWxorg-devel-docs SUNWxorg-cfg"

# snv_118: 6850136 Removal of Xsun-based Xvfb & Xnest servers [PSARC 2008/033]
REM_PKGS+=" SUNWxwsrv"

# snv_118: 6781710 Removal of Xsun on x86/x64 [PSARC 2008/033]
# snv_135: 6926932 Removal of Xsun on SPARC [PSARC 2008/033]
REM_PKGS+=" SUNWxsun-headers SUNWxsun-server SUNWxwts SUNWxwpsr"

# snv_120: 6859233 Removal of Xprint [PSARC 2009/294]
REM_PKGS+=" SUNWxprint-server SUNWxwpft"

# snv_122: 6868816 move xscreensaver from X consolidation to Desktop cons.
# Packages intentionally not added to REM_PKGS since they were moved
# to Desktop, and upgrade-X should no longer touch them.

# Check for shared SMF manifest scripts now required by our packages
if [[ ! -f /usr/sadm/install/scripts/i.manifest ]] ; then
    fatal_error "Cannot install on a Nevada build older than nv_17.\n" \ 
     "This build of X requires a system with the shared SMF manifest class\n" \
     "action scripts installed in /usr/sadm/install/scripts/i.manifest\n" \
     "(See Solaris bug id 6209178)\n"
fi

# /etc/svc & /var/svc/profile directories needed by manifest packaging scripts
altroot_dir_check /etc 0755 root:sys
altroot_dir_check /etc/svc 0755 root:sys
altroot_dir_check /var/svc 0755 root:sys
altroot_dir_check /var/svc/profile 0755 root:sys

# Need to be able to install symlinks to /usr/lib/isaexec in SUNWxorg-server
if [[ (! -z "${ALTROOT}") && (! -f "${ALTROOT}/usr/lib/isaexec") ]] ; then
    altroot_dir_check /usr 0755 root:sys
    altroot_dir_check /usr/lib 0755 root:sys
    touch ${ALTROOT}/usr/lib/isaexec
fi

# S10/greenline upgrade support
function svc_disable 
{
    svcname="svc:$1:default";
    if [[ "$2" = "" ]] ; then
	manifest="/var/svc/manifest/$1.xml"
    else
	manifest="/var/svc/manifest/$2"
    fi

    if [[ -f $manifest ]] ; then
	/usr/sbin/svcadm -v disable -s $svcname 2>&1 | tee -a $PKG_UPGRADE_LOG
    fi
}


###
#
#   Do the upgrade
#
###

print ""
print "Starting X ${XVERS} Build ${X_BUILD} ${ACTION}"
if [[ ! -z ${ALTROOT} ]] ; then
    print " in alternate root ${ALTROOT}"
fi
print "  The ${ACTION} log file can be found at:"
print "    $PKG_UPGRADE_LOG"
print ""

VERBOSE="-n -a /tmp/admin.$$"

cat >/tmp/admin.$$ <<EOF
basedir=default
mail=
runlevel=quit
conflict=nocheck
setuid=nocheck
action=nocheck
partial=nocheck
instance=unique
idepend=nocheck
rdepend=nocheck
space=quit
EOF

# Back up OWconfig before adding/removing packages to 
# workaround pkg bug 4946663/4992643
if [[ -f ${ALTROOT}/usr/openwin/server/etc/OWconfig ]]; then
    cp ${ALTROOT}/usr/openwin/server/etc/OWconfig ${ALTROOT}/var/tmp/OWconfig.${DATE}
fi

# Remove all instances of the specified package
function remove_package 
{
    pkg=$1
    if /bin/pkginfo ${ADDITIONAL_PKG_FLAGS} -q ${pkg}.\* ; then
	for p in $(pkginfo ${ADDITIONAL_PKG_FLAGS} ${pkg}.\* | awk '{print $2}') ; do
	    if [[ -z ${ALTROOT} ]] ; then
		case "$pkg" in
		    SUNWxwplr*)
			svc_disable network/fs/tcp6 network/fs-tcp6.xml
			svc_disable application/opengl/ogl-select
			svc_disable application/x11/xfs
			svc_disable application/x11/xvnc-inetd
			;;
		    SUNWfontconfig-root*)
			svc_disable application/font/fc-cache
			;;
		    SUNWstsfr*)
			svc_disable application/font/stfsloader
			;;
		esac
	    fi
	    /usr/sbin/pkgrm ${ADDITIONAL_PKG_FLAGS} ${VERBOSE} ${p} 2>&1 \
		| tee -a ${PKG_UPGRADE_LOG} | grep $pkg
	done
    fi
}

# Remove packages in reverse order, so mkfontdir/etc. are removed last
reverse_pkg_list="$(print -f '%s\n' ${pkg_list} | tail -r)"

for pkg in ${REM_PKGS} ${reverse_pkg_list}; do
    remove_package $pkg
done

# Special handling for Sun OpenGL on SPARC until their packages are updated
if [[ "${MACH}" == "sparc" ]] ; then
    if [[ -h ${ALTROOT}/usr/include/GL ]] ; then
	print "Moving SUNWglh links"| tee -a ${PKG_UPGRADE_LOG}
	removef ${ADDITIONAL_PKG_FLAGS} SUNWglh /usr/include/GL \
		| tee -a ${PKG_UPGRADE_LOG}
	rm ${ALTROOT}/usr/include/GL
	installf ${ADDITIONAL_PKG_FLAGS} SUNWglh \
		/usr/include/SUNWgl=../openwin/include/GL s \
		| tee -a ${PKG_UPGRADE_LOG}
	installf -f SUNWglh | tee -a ${PKG_UPGRADE_LOG}
    fi
    if [[ -h ${ALTROOT}/usr/lib/libGL.so.1 ]] ; then
	print "Moving SUNWglrt links" | tee -a ${PKG_UPGRADE_LOG}
	removef ${ADDITIONAL_PKG_FLAGS} SUNWglrt \
		/usr/lib/libGL* /usr/lib/sparcv9/libGL* \
		| tee -a ${PKG_UPGRADE_LOG}
	rm ${ALTROOT}/usr/lib/libGL* ${ALTROOT}/usr/lib/sparcv9/libGL*
	mkdir -p ${ALTROOT}/usr/lib/SUNWgl/sparcv9
	for f in ${ALTROOT}/usr/openwin/lib/libGL* ; do
	    bf=$(basename $f)
	    installf ${ADDITIONAL_PKG_FLAGS} SUNWglrt \
		/usr/lib/SUNWgl/$bf=../../openwin/lib/$bf s \
		| tee -a ${PKG_UPGRADE_LOG}
	done
	for f in ${ALTROOT}/usr/openwin/lib/sparcv9/libGL* ; do
	    bf=$(basename $f)
	    installf ${ADDITIONAL_PKG_FLAGS} SUNWglrt \
		/usr/lib/SUNWgl/sparcv9/$bf=../../../openwin/lib/$bf s \
		| tee -a ${PKG_UPGRADE_LOG}
	done
	installf -f SUNWglrt | tee -a ${PKG_UPGRADE_LOG}
    fi
fi

if [[ $REMOVE_ONLY -eq 0 ]] ; then
    for pkg in ${pkg_list} ; do
	if [[ -e $pkg ]] ; then
	    /usr/sbin/pkgadd ${ADDITIONAL_PKG_FLAGS} -S ${VERBOSE} \
		-d . $pkg 2>&1 | tee -a ${PKG_UPGRADE_LOG} | grep $pkg
	    print ""
	else
	    if [[ $QUIET -eq 0 ]] ; then
		print "No replacement found for $pkg"
	    fi
	fi
    done

    # Start the rebuild of fontconfig caches & reset OpenGL links now, 
    # instead of at next reboot
    if [[ -z "${ALTROOT}" ]] ; then
	/usr/sbin/svccfg -s application/font/fc-cache setprop options/force_rebuild="true"
	/usr/sbin/svcadm restart application/font/fc-cache
	/usr/sbin/svcadm enable application/font/fc-cache
	/usr/sbin/svcadm restart application/opengl/ogl-select
    fi
fi

print "X ${XVERS} ${action} is complete"
print " "
print "  The ${action} log file can be found at:"
print "    $PKG_UPGRADE_LOG"

exit 0
