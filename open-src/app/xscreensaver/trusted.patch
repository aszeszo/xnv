/*
 * Copyright 2006 Sun Microsystems, Inc.  All rights reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, and/or sell copies of the Software, and to permit persons
 * to whom the Software is furnished to do so, provided that the above
 * copyright notice(s) and this permission notice appear in all copies of
 * the Software and that both the above copyright notice(s) and this
 * permission notice appear in supporting documentation.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT
 * OF THIRD PARTY RIGHTS. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
 * HOLDERS INCLUDED IN THIS NOTICE BE LIABLE FOR ANY CLAIM, OR ANY SPECIAL
 * INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES WHATSOEVER RESULTING
 * FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
 * NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
 * WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * Except as contained in this notice, the name of a copyright holder
 * shall not be used in advertising or otherwise to promote the sale, use
 * or other dealings in this Software without prior written authorization
 * of the copyright holder.
 *
 */

Support needed for Solaris Trusted Extensions / Trusted Java Desktop System.

diff -urp -x '*~' configure.in configure.in
--- configure.in	2006-08-08 17:27:15.440757000 -0700
+++ configure.in	2006-08-08 17:27:22.191138000 -0700
@@ -3440,6 +3440,18 @@ fi
 AC_SUBST([XPM_LOGO_FILE])
 AC_SUBST([XPM_LOGO_NAME])
 
+if test -r driver/tsunlogo.xpm ; then
+	TRUSTED_XPM_LOGO_FILE=tsunlogo.xpm
+	TRUSTED_XPM_LOGO_NAME=tsunlogo_xpm
+	TRUSTED_XPM_COMMENT=""
+else
+	TRUSTED_XPM_COMMENT="#"
+fi
+
+AC_SUBST([TRUSTED_XPM_LOGO_FILE])
+AC_SUBST([TRUSTED_XPM_LOGO_NAME])
+AC_SUBST([TRUSTED_XPM_COMMENT])
+
 #--- End SUNW addition
 
 if test "$have_kerberos" = yes; then
diff -urp -x '*~' driver/Makefile.in driver/Makefile.in
--- driver/Makefile.in	2006-08-08 17:27:15.943106000 -0700
+++ driver/Makefile.in	2006-08-08 17:27:22.192257000 -0700
@@ -103,6 +103,10 @@ GTK_OBJS	= demo-Gtk.o demo-Gtk-conf.o @G
 GTK_LOCK_SRCS	= lock-Gtk.c remote.c
 GTK_LOCK_OBJS	= lock-Gtk.o remote.o
 
+TRUSTED_LIBS	= -lglib-2.0 -lsecdb
+TRUSTED_SRCS	= trusted-utils.c
+TRUSTED_OBJS	= trusted-utils.o
+
 PWENT_SRCS	= passwd-pwent.c
 PWENT_OBJS	= passwd-pwent.o
 
@@ -774,8 +778,10 @@ lock.o:
 	  $(srcdir)/lock.c
 
 # lock-Gtk takes extra -D and -I options.
+@TRUSTED_XPM_COMMENT@ TRUSTED_LOGO_DEFS=-DTRUSTED_XPM_LOGO_FILE=\"@TRUSTED_XPM_LOGO_FILE@\" \
+@TRUSTED_XPM_COMMENT@		  -DTRUSTED_XPM_LOGO_NAME=@TRUSTED_XPM_LOGO_NAME@
 GTK_LOCK_LOGO_DEFS=-DXPM_LOGO_FILE=\"@XPM_LOGO_FILE@\" \
-		  -DXPM_LOGO_NAME=@XPM_LOGO_NAME@
+		  -DXPM_LOGO_NAME=@XPM_LOGO_NAME@ $(TRUSTED_LOGO_DEFS)
 
 lock-Gtk.o: lock-Gtk.c
 	$(CC) -c $(INCLUDES) -I$(ICON_SRC) $(GTK_DEFS) \
@@ -794,8 +800,9 @@ XScreenSaver_Xm_ad.h: XScreenSaver-Xm.ad
 
 # The executables linked in this directory.
 #
-xscreensaver: $(SAVER_OBJS)
-	$(CC) $(LDFLAGS) -o $@ $(SAVER_OBJS) $(SAVER_LIBS)
+xscreensaver: $(SAVER_OBJS) $(TRUSTED_OBJS)
+	$(CC) $(LDFLAGS) -o $@ $(SAVER_OBJS) $(TRUSTED_OBJS) \
+	$(TRUSTED_LIBS) $(SAVER_LIBS)
 
 xscreensaver-command: $(CMD_OBJS)
 	$(CC) $(LDFLAGS) -o $@ $(CMD_OBJS) $(CMD_LIBS)
@@ -814,8 +821,9 @@ xscreensaver-demo: @PREFERRED_DEMO_PROGR
 xscreensaver-lock: @PREFERRED_LOCK_PROGRAM@
 	$(INSTALL_PROGRAM) @PREFERRED_LOCK_PROGRAM@ $@
 
-xscreensaver-lock-Gtk: $(GTK_LOCK_OBJS)
+xscreensaver-lock-Gtk: $(GTK_LOCK_OBJS) $(TRUSTED_OBJS)
 	$(CC) $(LDFLAGS) -o $@ $(GTK_LOCK_OBJS) $(LIBS) $(X_LIBS) \
+	$(TRUSTED_OBJS) $(TRUSTED_LIBS) \
 	$(GTK_LIBS) $(XML_LIBS) $(X_PRE_LIBS) -lXt -lX11 \
 	$(XDPMS_LIBS) -lXext \
 	$(X_EXTRA_LIBS)
@@ -825,16 +833,18 @@ xscreensaver-demo-Xm: $(DEMO_OBJS) $(MOT
 	$(MOTIF_LIBS) $(INTL_LIBS) $(X_PRE_LIBS) -lXt -lX11 \
 	$(XDPMS_LIBS) $(XINERAMA_LIBS) -lXext $(X_EXTRA_LIBS)
 
-xscreensaver-demo-Gtk: $(DEMO_OBJS) $(GTK_OBJS)
-	$(CC) $(LDFLAGS) -o $@ $(DEMO_OBJS) $(GTK_OBJS) $(LIBS) $(X_LIBS) \
-	$(GTK_LIBS) $(XPM_LIBS) $(XML_LIBS) $(INTL_LIBS) $(X_PRE_LIBS) \
+xscreensaver-demo-Gtk: $(DEMO_OBJS) $(GTK_OBJS) $(TRUSTED_OBJS)
+	$(CC) $(LDFLAGS) -o $@ $(DEMO_OBJS) $(GTK_OBJS) $(TRUSTED_OBJS) \
+	$(LIBS) $(X_LIBS) $(GTK_LIBS) $(XPM_LIBS) $(XML_LIBS) $(INTL_LIBS) \
+	$(TRUSTED_LIBS) $(X_PRE_LIBS) \
 	-lXt -lX11 $(XDPMS_LIBS) $(XINERAMA_LIBS) -lXext $(X_EXTRA_LIBS)
 
 demo-Gtk.o: XScreenSaver_ad.h
 demo-Xm.o:  XScreenSaver_ad_Xm.h
 
-xscreensaver-getimage: $(GETIMG_OBJS)
-	$(CC) $(LDFLAGS) -o $@ $(GETIMG_OBJS) $(GETIMG_LIBS) -lm
+xscreensaver-getimage: $(GETIMG_OBJS) $(TRUSTED_OBJS)
+	$(CC) $(LDFLAGS) -o $@ $(GETIMG_OBJS) $(TRUSTED_OBJS) \
+	$(GETIMG_LIBS) $(TRUSTED_LIBS) -lm
 
 pdf2jpeg: $(PDF2JPEG_OBJS)
 	$(OBJCC) $(LDFLAGS) -o $@ $(PDF2JPEG_OBJS) $(PDF2JPEG_LIBS) -lm
diff -urp -x '*~' driver/demo-Gtk.c driver/demo-Gtk.c
--- driver/demo-Gtk.c	2006-08-08 17:27:16.160940000 -0700
+++ driver/demo-Gtk.c	2006-08-08 17:27:22.195132000 -0700
@@ -136,6 +136,8 @@
 #include <string.h>
 #include <ctype.h>
 
+#include <user_attr.h>
+
 #ifdef HAVE_GTK2
 enum {
   COL_ENABLED,
@@ -153,6 +155,7 @@ static void hack_subproc_environment (Wi
 #undef countof
 #define countof(x) (sizeof((x))/sizeof((*x)))
 
+extern Display *global_dpy;
 
 char *progname = 0;
 char *progclass = "XScreenSaver";
@@ -2673,10 +2676,15 @@ update_list_sensitivity (state *s)
 #endif /* !HAVE_GTK2 */
 }
 
+void XTSOLgetWorkstationOwner(Display *, uid_t *);
+char *getusrattrval(userattr_t *, char *);
+gboolean tsol_is_multi_label_session (void);
 
 static void
 populate_prefs_page (state *s)
 {
+  static gboolean tsol_hack_initialized = False;
+  static gboolean tsol_multi_label_session = False;
   saver_preferences *p = &s->prefs;
 
   Bool can_lock_p = True;
@@ -2855,10 +2863,62 @@ populate_prefs_page (state *s)
     SENSITIZE ("pwd_spinbutton", p->pwd_p);
     SENSITIZE ("pwd_mlabel",     p->pwd_p);
 
+    tsol_multi_label_session = tsol_is_multi_label_session();
+    if ( ! tsol_hack_initialized && tsol_multi_label_session )
+    {
+	GtkWidget *lock_spinbutton = name_to_widget(s, "lock_spinbutton");
+	GtkWidget *lock_container = name_to_widget(s, "blanking_table");
+	GtkWidget *lock_button_eventbox = name_to_widget(s, "lock_button_eventbox");
+	Widget *newlabel = g_object_new(GTK_TYPE_LABEL, "label",
+			_("_Lock Screen After"), 
+			"use-underline", TRUE,
+			"mnemonic-widget", lock_spinbutton,
+			NULL);
+	GValue *gv = g_new0(GValue, 1);
+	GtkAdjustment *adj;
+	userattr_t *uent;
+	int idletime;
+	char *value = NULL;
+	uid_t WorkstationOwner;
+	Display *dpy = GDK_DISPLAY();
+
+	adj = gtk_spin_button_get_adjustment((GtkSpinButton  *)lock_spinbutton);
+
+	XTSOLgetWorkstationOwner(dpy, &WorkstationOwner);
+	uent = getuseruid(WorkstationOwner);
+	value = getusrattrval(uent, USERATTR_IDLETIME_KW);
+	if (value != NULL && *value != '\0')
+	  idletime = atoi(value);
+	adj->upper = (gdouble)idletime;
+	if (adj->value > adj->upper)
+	  adj->value = adj->upper;
+
+	gtk_spin_button_set_adjustment((GtkSpinButton *)lock_spinbutton, adj);
+
+	gtk_container_add(GTK_CONTAINER(lock_container), GTK_WIDGET(newlabel));
+	g_value_init(gv, G_TYPE_INT);
+	g_value_set_int(gv, 2);
+	gtk_container_child_set_property(GTK_CONTAINER(lock_container), GTK_WIDGET(newlabel), "top_attach", gv); 
+	g_value_set_int(gv, 1);
+	gtk_container_child_set_property(GTK_CONTAINER(lock_container), GTK_WIDGET(newlabel), "left_attach", gv); 
+	gtk_widget_show(GTK_WIDGET(newlabel));
+	gtk_widget_hide(GTK_WIDGET(lock_button_eventbox));
+	g_object_set(lock_button_eventbox, "active", TRUE, NULL);
+
+	SENSITIZE ("lock_button",     1);
+    } 
+
+    if ( tsol_multi_label_session )
+    {
+	SENSITIZE ("lock_spinbutton", 1);
+	SENSITIZE ("lock_mlabel",     1);
+    }
+    else
+    {
     SENSITIZE ("lock_button",     can_lock_p);
     SENSITIZE ("lock_spinbutton", can_lock_p && p->lock_p);
     SENSITIZE ("lock_mlabel",     can_lock_p && p->lock_p);
-
+    }
     /* DPMS
      */
     SENSITIZE ("dpms_frame",              dpms_supported);
@@ -2887,6 +2947,7 @@ populate_prefs_page (state *s)
 
 # undef SENSITIZE
   }
+  tsol_hack_initialized = True;
 }
 
 
@@ -4845,7 +4906,7 @@ main (int argc, char **argv)
                                      applicationShellWidgetClass,
                                      dpy, 0, 0);
 
-  dpy = XtDisplay (toplevel_shell);
+  global_dpy = dpy = XtDisplay (toplevel_shell);
   db = XtDatabase (dpy);
   XtGetApplicationNameAndClass (dpy, &progname, &progclass);
   XSetErrorHandler (demo_ehandler);
diff -urp -x '*~' driver/prefs.c driver/prefs.c
--- driver/prefs.c	2006-08-08 17:27:16.076574000 -0700
+++ driver/prefs.c	2006-08-08 17:27:22.267393000 -0700
@@ -37,6 +37,7 @@
 # include "vms-pwd.h"
 #endif /* VMS */
 
+#include <user_attr.h>
 
 /* This file doesn't need the Xt headers, so stub these types out... */
 #undef XtPointer
@@ -66,6 +67,7 @@
 
 #include "prefs.h"
 #include "resources.h"
+#include "trusted-utils.h"
 
 /* don't use realpath() on fedora system */
 #ifdef _FORTIFY_SOURCE
@@ -77,6 +79,7 @@ extern char *progname;
 extern char *progclass;
 extern const char *blurb (void);
 
+Display *global_dpy;
 
 
 static void get_screenhacks (Display *, saver_preferences *);
@@ -1021,6 +1024,9 @@ free_screenhack_list (screenhack **list,
   free (list);
 }
 
+void XTSOLgetWorkstationOwner(Display *, uid_t *);
+char *getusrattrval(userattr_t *, char *);
+int tsol_is_multi_label_session (void);
 
 
 /* Populate `saver_preferences' with the contents of the resource database.
@@ -1061,7 +1067,10 @@ load_init_file (Display *dpy, saver_pref
   p->xsync_p	    = get_boolean_resource (dpy, "synchronous", "Synchronous");
   p->verbose_p	    = get_boolean_resource (dpy, "verbose", "Boolean");
   p->timestamp_p    = get_boolean_resource (dpy, "timestamp", "Boolean");
-  p->lock_p	    = get_boolean_resource (dpy, "lock", "Boolean");
+  if ( tsol_is_multi_label_session() )
+    p->lock_p       = True; /* always lock in a Multi Label Session */
+  else
+    p->lock_p       = get_boolean_resource (dpy, "lock", "Boolean");
   p->fade_p	    = get_boolean_resource (dpy, "fade", "Boolean");
   p->unfade_p	    = get_boolean_resource (dpy, "unfade", "Boolean");
   p->fade_seconds   = 1000 * get_seconds_resource (dpy, "fadeSeconds", "Time");
@@ -1085,6 +1094,27 @@ load_init_file (Display *dpy, saver_pref
   p->lock_timeout    = 1000 * get_minutes_resource (dpy, "lockTimeout", "Time");
   p->cycle           = 1000 * get_minutes_resource (dpy, "cycle", "Time");
   p->passwd_timeout  = 1000 * get_seconds_resource (dpy, "passwdTimeout", "Time");
+  if ( tsol_is_multi_label_session() )
+  {
+    userattr_t *uent;
+    int idletime;
+    char *value = NULL;
+    uid_t WorkstationOwner;
+
+    XTSOLgetWorkstationOwner(global_dpy, &WorkstationOwner);
+    uent = getuseruid(WorkstationOwner);
+    value = getusrattrval(uent, USERATTR_IDLETIME_KW);
+    if (value != NULL && *value != '\0')
+      idletime = atoi(value) * 1000;
+    if (p->passwd_timeout > idletime)
+      p->passwd_timeout = idletime;
+    
+    value = getusrattrval(uent, USERATTR_IDLECMD_KW);
+    if (value && strcmp(value, USERATTR_IDLECMD_LOGOUT_KW) == 0)
+      p->lock_cmd = LOGOUT_CMD;
+    else
+      p->lock_cmd = LOCK_CMD;
+  }
   /* *bugid 5077981 pwd timeout */
   p->pwd_p	    = get_boolean_resource (dpy, "passwdTimeoutEnabled", "Boolean");
   p->pointer_timeout = 1000 * get_seconds_resource (dpy, "pointerPollTime", "Time");
diff -urp -x '*~' driver/prefs.h driver/prefs.h
--- driver/prefs.h	2006-08-08 17:27:15.972813000 -0700
+++ driver/prefs.h	2006-08-08 17:27:22.267954000 -0700
@@ -81,6 +81,7 @@ struct saver_preferences {
   Time initial_delay;		/* how long to sleep after launch */
   Time splash_duration;		/* how long the splash screen stays up */
   Time timeout;			/* how much idle time before activation */
+  int lock_cmd;			/* tsol only  - whether to lock or logout */
   Time lock_timeout;		/* how long after activation locking starts */
   Time cycle;			/* how long each hack should run */
   Time passwd_timeout;		/* how much time before pw dialog goes down */
diff -urp -x '*~' driver/subprocs.c driver/subprocs.c
--- driver/subprocs.c	2006-08-08 17:27:16.150981000 -0700
+++ driver/subprocs.c	2006-08-08 17:27:22.269506000 -0700
@@ -71,6 +71,7 @@ extern int kill (pid_t, int);		/* signal
 #include "exec.h"
 #include "yarandom.h"
 #include "visual.h"    /* for id_to_visual() */
+#include "trusted-utils.h"
 
 extern saver_info *global_si_kludge;	/* I hate C so much... */
 
@@ -1020,6 +1021,13 @@ spawn_screenhack_1 (saver_screen_info *s
 					      strlen (HACK_PATH)); 
       sprintf(complete_hack_command, HACK_PATH"/%s", hack->command);
       
+      if ( tsol_is_multi_label_session() )
+	if (p->lock_cmd == LOGOUT_CMD)
+	  {
+	    free (complete_hack_command);
+	    exec_command (p->shell, "/usr/bin/pkill gnome-session", 0);
+	    exit(1);
+	  }
       
       forked = fork_and_exec (ssi, complete_hack_command);
       free (complete_hack_command);
diff -urp -x '*~' driver/xscreensaver-getimage.c driver/xscreensaver-getimage.c
--- driver/xscreensaver-getimage.c	2006-03-09 13:35:35.000000000 -0800
+++ driver/xscreensaver-getimage.c	2006-08-08 17:27:22.270497000 -0700
@@ -83,6 +83,7 @@ static char *defaults[] = {
  0
 };
 
+extern Display *global_dpy;
 
 
 char *progname = 0;
@@ -1761,7 +1762,7 @@ main (int argc, char **argv)
 
   toplevel = XtAppInitialize (&app, progclass, 0, 0, &argc, argv,
                               defaults, 0, 0);
-  dpy = XtDisplay (toplevel);
+  global_dpy = dpy = XtDisplay (toplevel);
   screen = XtScreen (toplevel);
   db = XtDatabase (dpy);
   XtGetApplicationNameAndClass (dpy, &s, &progclass);
diff -urp -x '*~' driver/xscreensaver.c driver/xscreensaver.c
--- driver/xscreensaver.c	2006-08-08 17:27:16.183058000 -0700
+++ driver/xscreensaver.c	2006-08-08 17:27:22.283861000 -0700
@@ -198,6 +198,7 @@ passwd_dialog_data *ptr_mygtkpwd = &mygt
 char *progname = 0;
 char *progclass = 0;
 XrmDatabase db = 0;
+extern Display *global_dpy;
 
 
 static Atom XA_SCREENSAVER_RESPONSE;
@@ -1517,6 +1518,7 @@ while (debug_flag)
   hack_environment (si);
 
   shell = connect_to_server (si, &argc, argv);
+  global_dpy = XtDisplay(shell);
   process_command_line (si, &argc, argv);
   print_banner (si);
 
