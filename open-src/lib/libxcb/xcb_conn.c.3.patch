# Patch submitted by Aaron Plattner <aplattner@nvidia.com>
# to the xorg and xcb mailing lists on 07/11/2010.
--- src/xcb_conn.c	2010-08-13 04:43:31.000000000 -0700
+++ src/xcb_conn.c	2010-10-12 11:56:57.943981000 -0700
@@ -337,6 +337,16 @@
         if(FD_ISSET(c->fd, &wfds))
 #endif
             ret = ret && write_vec(c, vector, count);
+
+#if USE_POLL
+	if((fd.revents & (POLLERR |
+			POLLHUP |
+			POLLNVAL)))
+	{
+	    _xcb_conn_shutdown(c);
+	    ret = 0;
+	}
+#endif
     }
 
     if(count)
