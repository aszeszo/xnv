# Copyright 2007 Sun Microsystems, Inc.  All rights reserved.
# Use subject to license terms.
#
# Permission is hereby granted, free of charge, to any person obtaining a
# copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, and/or sell copies of the Software, and to permit persons
# to whom the Software is furnished to do so, provided that the above
# copyright notice(s) and this permission notice appear in all copies of
# the Software and that both the above copyright notice(s) and this
# permission notice appear in supporting documentation.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT
# OF THIRD PARTY RIGHTS. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
# HOLDERS INCLUDED IN THIS NOTICE BE LIABLE FOR ANY CLAIM, OR ANY SPECIAL
# INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES WHATSOEVER RESULTING
# FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
# NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
# WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
# 
# Except as contained in this notice, the name of a copyright holder
# shall not be used in advertising or otherwise to promote the sale, use
# or other dealings in this Software without prior written authorization
# of the copyright holder.

diff -urp -x '*~' src/mesa/drivers/dri/common/dri_util.h src/mesa/drivers/dri/common/dri_util.h
--- src/mesa/drivers/dri/common/dri_util.h	2006-03-31 07:48:04.000000000 -0800
+++ src/mesa/drivers/dri/common/dri_util.h	2006-11-09 18:03:19.022744000 -0800
@@ -60,6 +60,10 @@
 
 #define GLX_BAD_CONTEXT                    5
 
+#define u_int64_t uint64_t
+#define u_int32_t uint32_t
+#define u_int8_t uint8_t
+
 typedef struct __DRIdisplayPrivateRec  __DRIdisplayPrivate;
 typedef struct __DRIscreenPrivateRec   __DRIscreenPrivate;
 typedef struct __DRIcontextPrivateRec  __DRIcontextPrivate;
diff -urp -x '*~' src/mesa/drivers/dri/i915/intel_context.h src/mesa/drivers/dri/i915/intel_context.h
--- src/mesa/drivers/dri/i915/intel_context.h	2006-08-18 10:04:03.000000000 -0700
+++ src/mesa/drivers/dri/i915/intel_context.h	2006-11-09 18:03:19.023582000 -0800
@@ -44,6 +44,11 @@
 #include "tnl_dd/t_dd_vertex.h"
 #undef TAG
 
+#if defined(sun)
+extern void _sigoff(void);
+extern void _sigon(void);
+#endif
+
 #define DV_PF_555  (1<<8)
 #define DV_PF_565  (2<<8)
 #define DV_PF_8888 (3<<8)
@@ -316,6 +321,23 @@ extern int prevLockLine;
 
 /* Lock the hardware and validate our state.  
  */
+#if defined(sun)
+#define LOCK_HARDWARE( intel )				\
+do {							\
+    char __ret=0;					\
+    DEBUG_CHECK_LOCK();					\
+    assert(!(intel)->locked);				\
+    _sigoff();                                          \
+    DRM_CAS((intel)->driHwLock, (intel)->hHWContext,	\
+        (DRM_LOCK_HELD|(intel)->hHWContext), __ret);	\
+    if (__ret)						\
+        intelGetLock( (intel), 0 );			\
+      DEBUG_LOCK();					\
+    (intel)->locked = 1;				\
+}while (0)
+
+#else
+
 #define LOCK_HARDWARE( intel )				\
 do {							\
     char __ret=0;					\
@@ -328,10 +350,13 @@ do {							\
       DEBUG_LOCK();					\
     (intel)->locked = 1;				\
 }while (0)
+
+#endif
  
   
   /* Unlock the hardware using the global current context 
    */
+#if defined(sun)
 #define UNLOCK_HARDWARE(intel)						\
 do {									\
    intel->locked = 0;							\
@@ -341,8 +366,24 @@ do {									\
    }									\
    DRM_UNLOCK((intel)->driFd, (intel)->driHwLock, (intel)->hHWContext);	\
    DEBUG_RESET();							\
+   _sigon();                                                            \
 } while (0)
 
+#else
+
+#define UNLOCK_HARDWARE(intel)						\
+do {									\
+   intel->locked = 0;							\
+   if (0) { 								\
+      intel->perf_boxes |= intel->sarea->perf_boxes;  			\
+      intel->sarea->perf_boxes = 0;					\
+   }									\
+   DRM_UNLOCK((intel)->driFd, (intel)->driHwLock, (intel)->hHWContext);	\
+   DEBUG_RESET();							\
+} while (0)
+
+#endif
+
 
 #define SUBPIXEL_X 0.125
 #define SUBPIXEL_Y 0.125
@@ -383,7 +424,7 @@ do {						\
  * From linux kernel i386 header files, copes with odd sizes better
  * than COPY_DWORDS would:
  */
-#if defined(i386) || defined(__i386__)
+#if (defined(i386) || defined(__i386__)) && !(defined(__SOLARIS__) || defined(sun))
 static __inline__ void * __memcpy(void * to, const void * from, size_t n)
 {
    int d0, d1, d2;
diff -urp -x '*~' src/mesa/drivers/dri/i915/intel_screen.c src/mesa/drivers/dri/i915/intel_screen.c
--- src/mesa/drivers/dri/i915/intel_screen.c	2006-09-11 14:35:49.000000000 -0700
+++ src/mesa/drivers/dri/i915/intel_screen.c	2006-11-09 18:03:19.029524000 -0800
@@ -25,6 +25,8 @@
  * 
  **************************************************************************/
 
+#include <unistd.h>
+#include <signal.h>
 #include "glheader.h"
 #include "context.h"
 #include "framebuffer.h"
@@ -45,6 +47,15 @@
 
 #include "i830_dri.h"
 
+static void stop_handler(int sig)
+{
+	kill(getpid(), SIGSTOP);
+}
+static void exit_handler(int sig)
+{
+	_exit(1);
+}
+
 PUBLIC const char __driConfigOptions[] =
 DRI_CONF_BEGIN
     DRI_CONF_SECTION_PERFORMANCE
@@ -348,6 +359,13 @@ static GLboolean intelInitDriver(__DRIsc
    sPriv->psc->freeMemory     = (void *) intelFreeMemoryMESA;
    sPriv->psc->memoryOffset   = (void *) intelGetMemoryOffsetMESA;
 
+   (void) sigset(SIGTSTP, stop_handler);
+   (void) sigset(SIGTTIN, stop_handler);
+   (void) sigset(SIGTTOU, stop_handler);
+   (void) sigset(SIGINT, exit_handler);
+   (void) sigset(SIGTERM, exit_handler);
+
+
    return GL_TRUE;
 }
 		
diff -urp -x '*~' src/mesa/drivers/dri/i915/intel_tris.c src/mesa/drivers/dri/i915/intel_tris.c
--- src/mesa/drivers/dri/i915/intel_tris.c	2006-07-20 09:41:26.000000000 -0700
+++ src/mesa/drivers/dri/i915/intel_tris.c	2006-11-09 18:03:19.030336000 -0800
@@ -50,7 +50,7 @@ static void intelRasterPrimitive( GLcont
  *                    Emit primitives as inline vertices               *
  ***********************************************************************/
 
-#ifdef __i386__
+#if (defined(i386) || defined(__i386__)) && !(defined(__SOLARIS__) || defined(sun))
 #define COPY_DWORDS( j, vb, vertsize, v )			\
 do {								\
    int __tmp;							\
diff -urp -x '*~' src/mesa/main/glheader.h src/mesa/main/glheader.h
--- src/mesa/main/glheader.h	2006-04-12 18:52:32.000000000 -0700
+++ src/mesa/main/glheader.h	2006-11-09 18:03:19.041666000 -0800
@@ -197,7 +197,7 @@
 #  define INLINE __inline
 #elif defined(__ICL)
 #  define INLINE __inline
-#elif defined(__INTEL_COMPILER)
+#elif defined(__INTEL_COMPILER) || defined(__SUNPRO_C)
 #  define INLINE inline
 #elif defined(__WATCOMC__) && (__WATCOMC__ >= 1100)
 #  define INLINE __inline
@@ -205,6 +205,11 @@
 #  define INLINE
 #endif
 
+/* for Sun CC compiler */
+#ifdef __SUNPRO_C
+#define __inline inline
+#define __inline__ inline
+#endif
 
 /* If we build the library with gcc's -fvisibility=hidden flag, we'll
  * use the PUBLIC macro to mark functions that are to be exported.
diff -urp -x '*~' src/mesa/tnl_dd/t_dd_tritmp.h src/mesa/tnl_dd/t_dd_tritmp.h
--- src/mesa/tnl_dd/t_dd_tritmp.h	2005-05-25 06:35:21.000000000 -0700
+++ src/mesa/tnl_dd/t_dd_tritmp.h	2006-11-09 18:03:19.042310000 -0800
@@ -393,7 +393,7 @@ static void TAG(triangle)( GLcontext *ct
 
 #if DO_QUAD
 #if DO_FULL_QUAD
-static void TAG(quad)( GLcontext *ctx,
+static void TAG(quadr)( GLcontext *ctx,
 		       GLuint e0, GLuint e1, GLuint e2, GLuint e3 )
 {
    struct vertex_buffer *VB = &TNL_CONTEXT( ctx )->vb;
@@ -681,7 +681,7 @@ static void TAG(quad)( GLcontext *ctx,
    }
 }
 #else
-static void TAG(quad)( GLcontext *ctx, GLuint e0,
+static void TAG(quadr)( GLcontext *ctx, GLuint e0,
 		       GLuint e1, GLuint e2, GLuint e3 )
 {
    if (DO_UNFILLED) {
@@ -773,7 +773,7 @@ static void TAG(points)( GLcontext *ctx,
 static void TAG(init)( void )
 {
 #if DO_QUAD
-   TAB[IND].quad = TAG(quad);
+   TAB[IND].quad = TAG(quadr);
 #endif
 #if DO_TRI
    TAB[IND].triangle = TAG(triangle);

--- src/mesa/drivers/dri/Makefile.template	2006-07-12 19:43:20.000000000 -0700
+++ src/mesa/drivers/dri/Makefile.template	2006-11-09 18:34:11.827373000 -0800
@@ -49,7 +49,7 @@
 	-I$(TOP)/src/mesa/swrast_setup \
 	-I$(TOP)/src/egl/main \
 	-I$(TOP)/src/egl/drivers/dri \
-	`pkg-config --cflags libdrm`
+	$(LIBDRM_CFLAGS)
 
 ##### RULES #####
 
