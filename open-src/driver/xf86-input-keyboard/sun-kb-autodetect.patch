# Copyright 2009 Sun Microsystems, Inc.  All rights reserved.
# Use is subject to license terms.
#
# Permission is hereby granted, free of charge, to any person obtaining a
# copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, and/or sell copies of the Software, and to permit persons
# to whom the Software is furnished to do so, provided that the above
# copyright notice(s) and this permission notice appear in all copies of
# the Software and that both the above copyright notice(s) and this
# permission notice appear in supporting documentation.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT
# OF THIRD PARTY RIGHTS. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
# HOLDERS INCLUDED IN THIS NOTICE BE LIABLE FOR ANY CLAIM, OR ANY SPECIAL
# INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES WHATSOEVER RESULTING
# FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
# NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
# WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
# 
# Except as contained in this notice, the name of a copyright holder
# shall not be used in advertising or otherwise to promote the sale, use
# or other dealings in this Software without prior written authorization
# of the copyright holder.


diff -urp -x '*~' -x '*.orig' src/Makefile.am src/Makefile.am
--- src/Makefile.am	2009-01-07 08:47:02.000000000 -0800
+++ src/Makefile.am	2009-05-01 14:17:11.511906000 -0700
@@ -28,7 +28,7 @@ BSD_SRCS = bsd_KbdMap.c bsd_kbd.c bsd_kb
 HURD_SRCS = hurd_kbd.c at_scancode.c
 LINUX_SRCS = lnx_KbdMap.c lnx_kbd.c lnx_kbd.h at_scancode.c
 SCO_SRCS = sco_KbdMap.c sco_kbd.c sco_kbd.h
-SOLARIS_SRCS = sun_kbd.c sun_kbd.h sun_kbdMap.c
+SOLARIS_SRCS = sun_kbd.c sun_kbd.h sun_kbdMap.c sun_xkbtable.c sun_xkbtable.h
 
 if BSD
 kbd_drv_la_SOURCES += $(BSD_SRCS)
diff -urp -x '*~' -x '*.orig' src/sun_kbd.c src/sun_kbd.c
--- src/sun_kbd.c	2009-08-05 16:56:35.195954000 -0700
+++ src/sun_kbd.c	2009-08-05 16:56:35.982990000 -0700
@@ -68,6 +68,10 @@ static int KbdOn(InputInfoPtr pInfo, int
 static Bool OpenKeyboard(InputInfoPtr pInfo);
 static void CloseKeyboard(InputInfoPtr pInfo);
 
+#ifdef XKB
+# include "sun_xkbtable.h"
+#endif
+
 static void
 sunKbdSetLeds(InputInfoPtr pInfo, int leds)
 {
@@ -102,6 +106,13 @@ sunKbdGetLeds(InputInfoPtr pInfo)
 static int
 KbdInit(InputInfoPtr pInfo, int what)
 {
+    /* Does nothing now - sunKbdInit called from OpenKeyboard instead */
+    return Success;
+}
+
+static int
+sunKbdInit(InputInfoPtr pInfo)
+{
     KbdDevPtr pKbd = (KbdDevPtr) pInfo->private;
     sunKbdPrivPtr priv = (sunKbdPrivPtr) pKbd->private;
     pointer options = pInfo->options;
@@ -156,6 +167,7 @@ KbdInit(InputInfoPtr pInfo, int what)
     xf86Msg(X_PROBED, "%s: Keyboard layout: %d\n", pInfo->name, klayout);
 
     priv->ktype 	= ktype;
+    priv->klayout 	= klayout;
 
     return Success;
 }
@@ -495,6 +507,61 @@ OpenKeyboard(InputInfoPtr pInfo)
     if (pInfo->fd == -1) {
 	return FALSE;
     } else {
+	if (sunKbdInit(pInfo) != Success) {
+	    close(pInfo->fd);
+	    pInfo->fd = -1;
+	    return FALSE;
+	}
+#ifdef XKB
+	else {
+	    /* Probe keyboard settings if not specified in configuration */
+	    KbdDevPtr pKbd = (KbdDevPtr) pInfo->private;
+	    sunKbdPrivPtr priv = (sunKbdPrivPtr) pKbd->private;
+	    char *xkbkeymap = NULL, *xkbmodel = NULL, *xkblayout = NULL;
+	    int i, found;
+	    
+	    const char *kbdDefaults[] = {
+		"Protocol",         "standard",
+		"AutoRepeat",       "500 30",
+		"XkbRules",         "xorg",
+		"XkbModel",         "pc105",
+		"XkbLayout",        "us",
+		"Panix106",         "off",
+		"CustomKeycodes",   "off",
+		NULL, NULL, 	    /* leave room to add XkbKeymap if needed */
+		NULL 		    /* list terminator */
+	    };
+	    
+	    sun_find_xkbnames(priv->ktype, priv->klayout,
+			      &xkbkeymap, &xkbmodel, &xkblayout);
+
+#define SetXkbDefaults(OPTION, VALUE) \
+	if (VALUE != NULL) { \
+	    for (i = 0, found = 0; kbdDefaults[i] != NULL; i += 2) { \
+		if (strcmp(kbdDefaults[i], OPTION) == 0) { \
+		    kbdDefaults[i+1] = VALUE; found++; \
+		    xf86Msg(X_PROBED, "%s: %s = %s\n", pInfo->name, \
+			    OPTION, VALUE); \
+		    break; \
+		} \
+	    } \
+	}
+	    
+#define AddXkbDefaults(OPTION, VALUE) \
+	if (VALUE != NULL) { \
+	    for (i = 0; kbdDefaults[i] != NULL; i += 2) \
+	    { /* skip to end */ ; } \
+	    kbdDefaults[i++] = OPTION; \
+	    kbdDefaults[i++] = VALUE; \
+	}
+
+	    SetXkbDefaults("XkbModel", xkbmodel);
+	    SetXkbDefaults("XkbLayout", xkblayout);
+	    AddXkbDefaults("XkbKeymap", xkbkeymap);
+
+	    xf86CollectInputOptions(pInfo, kbdDefaults, NULL);
+	}
+#endif
 	pInfo->read_input = ReadInput;
 	return TRUE;
     }
diff -urp -x '*~' -x '*.orig' src/sun_kbd.h src/sun_kbd.h
--- src/sun_kbd.h	2009-05-01 14:17:10.638824000 -0700
+++ src/sun_kbd.h	2009-05-01 14:17:11.529300000 -0700
@@ -31,6 +31,7 @@
 
 typedef struct {
     int 		ktype;		/* Keyboard type from KIOCTYPE */
+    int 		klayout;	/* Keyboard layout from KIOCLAYOUT */
     Bool		kbdActive;	/* Have we set kbd modes for X? */
     int 		otranslation;	/* Original translation mode */
     int 		odirect;	/* Original "direct" mode setting */
