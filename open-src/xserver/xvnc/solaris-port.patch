# Copyright 2009 Sun Microsystems, Inc.  All rights reserved.
# Use is subject to license terms.
#
# Permission is hereby granted, free of charge, to any person obtaining a
# copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, and/or sell copies of the Software, and to permit persons
# to whom the Software is furnished to do so, provided that the above
# copyright notice(s) and this permission notice appear in all copies of
# the Software and that both the above copyright notice(s) and this
# permission notice appear in supporting documentation.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT
# OF THIRD PARTY RIGHTS. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
# HOLDERS INCLUDED IN THIS NOTICE BE LIABLE FOR ANY CLAIM, OR ANY SPECIAL
# INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES WHATSOEVER RESULTING
# FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
# NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
# WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
#
# Except as contained in this notice, the name of a copyright holder
# shall not be used in advertising or otherwise to promote the sale, use
# or other dealings in this Software without prior written authorization
# of the copyright holder.
#

diff -urp -x '*~' -x '*.orig' common/rfb/Makefile.am common/rfb/Makefile.am
--- common/rfb/Makefile.am	2009-08-20 02:46:42.000000000 -0700
+++ common/rfb/Makefile.am	2009-10-20 18:58:01.733395720 -0700
@@ -42,7 +42,7 @@ librfb_la_SOURCES = $(HDRS) Blacklist.cx
 	secTypes.cxx util.cxx
 
 librfb_la_CPPFLAGS = -I$(top_srcdir) -I$(top_srcdir)/../win
-librfb_la_LIBADD =
+librfb_la_LIBADD = $(LIBS)
 
 if INCLUDED_JPEG
 librfb_la_CPPFLAGS += -I$(top_srcdir)/jpeg
diff -urp -x '*~' -x '*.orig' unix/vncserver unix/vncserver
--- unix/vncserver	2009-10-20 18:57:59.422472953 -0700
+++ unix/vncserver	2009-10-20 18:58:01.733670786 -0700
@@ -39,6 +39,7 @@ $vncClasses = "";
 
 $xauth = "xauth";
 
+$ENV{PATH} = "/usr/X11/bin:" . $ENV{PATH};
 &SanityCheck();
 
 #
@@ -75,6 +76,15 @@ $defaultXStartup
        "if [ -f /etc/X11/xinit/xinitrc ]; then\n".
        "  exec sh /etc/X11/xinit/xinitrc\n".
        "fi\n".
+       "if [ -x /etc/gdm/Xsession ] && [ -x /usr/bin/dtstart ] ; then\n".
+       "  exec /etc/gdm/Xsession /usr/bin/dtstart jds\n".
+       "fi\n".
+       "if [ -x /etc/X11/gdm/Xsession ] && [ -x /usr/bin/dtstart ] ; then\n".
+       "  exec /etc/X11/gdm/Xsession /usr/bin/dtstart jds\n".
+       "fi\n".
+       "if [ -x /usr/dt/config/Xsession.jds ]; then\n".
+       "  exec /usr/dt/config/Xsession.jds\n".
+       "fi\n".
        "[ -r \$HOME/.Xresources ] && xrdb \$HOME/.Xresources\n".
        "xsetroot -solid grey\n".
        "xterm -geometry 80x24+10+10 -ls -title \"\$VNCDESKTOP Desktop\" &\n".
diff -urp -x '*~' -x '*.orig' unix/vncviewer/Makefile.am unix/vncviewer/Makefile.am
--- unix/vncviewer/Makefile.am	2009-08-20 02:46:42.000000000 -0700
+++ unix/vncviewer/Makefile.am	2009-10-20 18:58:01.733812117 -0700
@@ -13,6 +13,7 @@ vncviewer_CPPFLAGS = -I$(COMMON_DIR) -I$
 
 vncviewer_LDADD = $(top_srcdir)/tx/libtx.la $(COMMON_DIR)/rfb/librfb.la \
 	$(COMMON_DIR)/network/libnetwork.la $(COMMON_DIR)/rdr/librdr.la \
+	-ljpeg -lz \
 	@X_PRE_LIBS@ @X_LIBS@ -lXext -lX11 @X_EXTRA_LIBS@ # @LIBINTL@
 
 EXTRA_DIST = vncviewer.man
diff -urp -x '*~' -x '*.orig' unix/x0vncserver/Makefile.am unix/x0vncserver/Makefile.am
--- unix/x0vncserver/Makefile.am	2009-08-20 02:46:42.000000000 -0700
+++ unix/x0vncserver/Makefile.am	2009-10-20 18:58:01.733948483 -0700
@@ -15,6 +15,7 @@ x0vncserver_CPPFLAGS = -I$(COMMON_DIR) -
 	@MITSHM_DEFINE@ @X_CFLAGS@
 
 x0vncserver_LDADD = $(COMMON_DIR)/rfb/librfb.la \
+	-ljpeg -lz \
 	$(COMMON_DIR)/network/libnetwork.la $(COMMON_DIR)/rdr/librdr.la \
 	$(top_srcdir)/tx/libtx.la @INET_LIB@ @X_PRE_LIBS@ @X_LIBS@ \
 	@XTEST_LIB@ -lXext -lX11 @X_EXTRA_LIBS@
diff -urp -x '*~' -x '*.orig' unix/xserver/hw/vnc/Makefile.am unix/xserver/hw/vnc/Makefile.am
--- unix/xserver/hw/vnc/Makefile.am	2009-08-20 02:46:42.000000000 -0700
+++ unix/xserver/hw/vnc/Makefile.am	2009-10-20 18:58:01.734107661 -0700
@@ -32,7 +32,14 @@ Xvnc_CPPFLAGS = $(XVNC_CPPFLAGS) -DNO_HW
 	-DVENDOR_STRING="\"$(VENDOR_STRING)\"" -I$(LIB_DIR) \
 	-I$(top_srcdir)/include -I$(includedir)/pixman-1 -I$(includedir)
 
+if BUILD_TSOL_MODULE
+TSOL_LIBS = 	../../tsol/libxtsol.la -ltsol -ltsnet -lsecdb -lbsm
+endif
+
 Xvnc_LDADD = $(XVNC_LIBS) libvnccommon.la $(COMMON_LIBS) \
+	-ljpeg -lz \
+	../../IA/libIA.la \
+	$(TSOL_LIBS) \
 	$(XSERVER_LIBS) $(XSERVER_SYS_LIBS) -lX11
 
 Xvnc_LDFLAGS = $(LD_EXPORT_SYMBOLS_FLAG)
@@ -60,8 +67,8 @@ BUILT_SOURCES = $(nodist_Xvnc_SOURCES)
 fb.h: $(top_srcdir)/fb/fb.h
 	cat $(top_srcdir)/fb/fb.h | sed -e 's,and,c_and,' -e 's,xor,c_xor,' > $(srcdir)/fb.h
 
-pixman.h: $(includedir)/pixman-1/pixman.h
-	cat $(includedir)/pixman-1/pixman.h | sed 's/xor/c_xor/' > $(srcdir)/pixman.h
+pixman.h: $(PROTODIR)/usr/include/pixman-1/pixman.h
+	cat $(PROTODIR)/usr/include/pixman-1/pixman.h | sed 's/xor/c_xor/' > $(srcdir)/pixman.h
 
 fbrop.h: $(top_srcdir)/fb/fbrop.h
 	cat $(top_srcdir)/fb/fbrop.h | sed -e 's,and,c_and,' -e 's,xor,c_xor,' > $(srcdir)/fbrop.h
diff -urp -x '*~' -x '*.orig' unix/xserver/hw/vnc/Xvnc.man unix/xserver/hw/vnc/Xvnc.man
--- unix/xserver/hw/vnc/Xvnc.man	2009-10-20 18:57:59.463630437 -0700
+++ unix/xserver/hw/vnc/Xvnc.man	2009-10-20 18:58:01.782738186 -0700
@@ -67,8 +67,7 @@ List all the options and parameters
 
 .SH PARAMETERS
 VNC parameters can be set both via the command-line and through the
-\fBvncconfig\fP(1) program, and with a VNC-enabled XFree86 server via Options
-entries in the XF86Config file.
+\fBvncconfig\fP(1) program.
 
 Parameters can be turned on with -\fIparam\fP or off with
 -\fIparam\fP=0.  Parameters which take a value can be specified as
@@ -221,12 +221,12 @@ is a hexadecimal keysym. For example, to
 RemapKeys=0x22<>0x40
 
 .SH USAGE WITH INETD
-By configuring the \fBinetd\fP(1) service appropriately, Xvnc can be launched
+By configuring the \fBinetd\fP(1M) service appropriately, Xvnc can be launched
 on demand when a connection comes in, rather than having to be started
 manually.  When given the \fB-inetd\fP option, instead of listening for TCP
 connections on a given port it uses its standard input and standard output.
 There are two modes controlled by the wait/nowait entry in the inetd.conf file.
-
+.PP
 In the nowait mode, Xvnc uses its standard input and output directly as the
 connection to a viewer.  It never has a listening socket, so cannot accept
 further connections from viewers (it can however connect out to listening
@@ -234,17 +234,26 @@ viewers by use of the vncconfig program)
 same TCP port result in inetd spawning off a new Xvnc to deal with each
 connection.  When the connection to the viewer dies, the Xvnc and any
 associated X clients die.  This behaviour is most useful when combined with the
-XDMCP options -query and -once.  An typical example in inetd.conf might be (all
-on one line):
-
-5950   stream   tcp nowait nobody  /usr/local/bin/Xvnc Xvnc -inetd -query
-localhost -once securitytypes=none
-
-In this example a viewer connection to :50 will result in a new Xvnc for that
-connection which should display the standard XDM login screen on that machine.
-Because the user needs to login via XDM, it is usually OK to accept connections
-without a VNC password in this case.
-
+XDMCP options -query and -once.  
+.PP
+The provided application/x11/xvnc-inetd service defaults to running
+
+.B "/usr/bin/Xvnc -inetd -query localhost -once securitytypes=none"
+
+in nowait mode.   This service can be enabled via 
+.BR svcadm (1m),
+and configured to use other modes or arguments via
+.BR svccfg (1m).
+.PP
+In this configuration, connecting to :0 will result in a new Xvnc for that
+connection which should display the standard graphical login screen on that 
+machine.   (To enable this, you will also have to enable XDMCP network 
+connections on the login screen.   See 
+.BR gdm (1)
+for details.)
+Because the user needs to login via this screen, it is usually OK to accept 
+connections without a VNC password in this case.
+.PP
 In the wait mode, when the first connection comes in, inetd gives the listening
 socket to Xvnc.  This means that for a given TCP port, there is only ever one
 Xvnc at a time.  Further viewer connections to the same port are accepted by
@@ -252,14 +261,14 @@ the same Xvnc in the normal way.  Even w
 the Xvnc will continue to run.  If this is used with the XDMCP options -query
 and -once, the Xvnc and associated X clients will die when the user logs out of
 the X session in the normal way.  It is important to use a VNC password in this
-case.  A typical entry in inetd.conf might be:
-
-5951   stream   tcp wait   james     /usr/local/bin/Xvnc Xvnc -inetd -query localhost -once passwordFile=/home/james/.vnc/passwd
+case.  A typical command line to include in the service exec property might be:
 
+.B "/usr/bin/Xvnc Xvnc -inetd -query localhost -once passwordFile=/home/james/.vnc/passwd"
+.PP
 In fact typically, you would have one entry for each user who uses VNC
 regularly, each of whom has their own dedicated TCP port which they use.  In
-this example, when user "james" connects to :51, he enters his VNC password,
-then gets the XDM login screen where he logs in in the normal way.  However,
+this example, when user "james" connects, he enters his VNC password,
+then gets the login screen where he logs in in the normal way.  However,
 unlike the previous example, if he disconnects, the session remains persistent,
 and when he reconnects he will get the same session back again.  When he logs
 out of the X session, the Xvnc will die, but of course a new one will be
diff -urp -x '*~' -x '*.orig' unix/xserver/hw/xfree86/x86emu/Makefile.am unix/xserver/hw/xfree86/x86emu/Makefile.am
--- unix/xserver/hw/xfree86/x86emu/Makefile.am	2009-10-11 19:52:40.000000000 -0700
+++ unix/xserver/hw/xfree86/x86emu/Makefile.am	2009-10-20 18:58:01.734528099 -0700
@@ -1,3 +1,4 @@
+if INT10_X86EMU
 noinst_LTLIBRARIES = libx86emu.la
 
 libx86emu_la_SOURCES = debug.c \
@@ -8,6 +9,7 @@ libx86emu_a_SOURCES = debug.c \
                       prim_ops.c \
                       sys.c \
                       x86emu.h
+endif
 
 INCLUDES = 
 
