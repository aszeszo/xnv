# Copyright 2007 Sun Microsystems, Inc.  All rights reserved.
# Use subject to license terms.
#
# Permission is hereby granted, free of charge, to any person obtaining a
# copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, and/or sell copies of the Software, and to permit persons
# to whom the Software is furnished to do so, provided that the above
# copyright notice(s) and this permission notice appear in all copies of
# the Software and that both the above copyright notice(s) and this
# permission notice appear in supporting documentation.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT
# OF THIRD PARTY RIGHTS. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
# HOLDERS INCLUDED IN THIS NOTICE BE LIABLE FOR ANY CLAIM, OR ANY SPECIAL
# INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES WHATSOEVER RESULTING
# FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
# NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION
# WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
# 
# Except as contained in this notice, the name of a copyright holder
# shall not be used in advertising or otherwise to promote the sale, use
# or other dealings in this Software without prior written authorization
# of the copyright holder.

--- hw/xfree86/os-support/solaris/sun_io.c	2006-10-11 13:46:15.000000000 -0700
+++ hw/xfree86/os-support/sunos/sun_io.c	2005-11-21 16:13:24.136515000 -0800
@@ -61,6 +62,12 @@
 #include "xf86_OSlib.h"
 #include "sun_kbd.h"
 
+#ifdef SUNSOFT
+# ifdef XKB
+#  include "sun_xkbtable.h"
+# endif
+#endif
+
 static sunKbdPrivRec sunKeyboardPriv;
 
 _X_HIDDEN void
@@ -92,6 +99,14 @@
 		   kbdName, kbdOptions)	!= Success) {
     	FatalError("Unable to initialize keyboard driver\n");
     }
+
+#ifdef SUNSOFT
+    /* Probe keyboard settings if not specified in configuration */
+    if (xf86Info.xkbcomponents_specified != TRUE) {
+	sun_find_xkbnames(sunKeyboardPriv.ktype, sunKeyboardPriv.klayout,
+	    &xf86Info.xkbkeymap, &xf86Info.xkbmodel, &xf86Info.xkblayout);
+    }
+#endif
 }
 
 _X_HIDDEN int


--- hw/xfree86/os-support/solaris/sun_kbd.c	2006-10-11 13:46:15.000000000 -0700
+++ hw/xfree86/os-support/sunos/sun_kbd.c	2005-11-21 16:14:05.978499000 -0800
@@ -72,6 +74,12 @@
 #include <poll.h>
 #endif
 
+#ifdef SUNSOFT
+# ifdef XKB
+#  include "sun_xkbtable.h"
+# endif
+#endif
+
 /***************************************************************************
  * Common implementation of routines shared by "keyboard" driver in sun_io.c
  * and "kbd" driver (later on in this file)
@@ -180,6 +188,7 @@
     xf86Msg(X_PROBED, "%s: Keyboard layout: %d\n", devName, klayout);
 
     priv->ktype 	= ktype;
+    priv->klayout 	= klayout;
     priv->keyMap	= sunGetKbdMapping(ktype);
     priv->audioState	= AB_INITIALIZING;
     priv->oleds 	= sunKbdGetLeds(priv);
@@ -507,10 +516,8 @@
 static int
 KbdInit(InputInfoPtr pInfo, int what)
 {
-    KbdDevPtr pKbd = (KbdDevPtr) pInfo->private;
-    sunKbdPrivPtr priv = (sunKbdPrivPtr) pKbd->private;
-
-    return sunKbdInit(priv, pInfo->fd, pInfo->name, pInfo->options);
+    /* Does nothing now - sunKbdInit called from OpenKeyboard instead */
+    return Success;
 }
 
 
@@ -616,6 +623,65 @@
     pInfo->fd = sunKbdOpen(pInfo->name, pInfo->options);
 
     if (pInfo->fd >= 0) {
+	KbdDevPtr pKbd = (KbdDevPtr) pInfo->private;
+	sunKbdPrivPtr priv = (sunKbdPrivPtr) pKbd->private;
+
+	if (sunKbdInit(priv, pInfo->fd, pInfo->name, pInfo->options)
+	    != Success) {
+	    close(pInfo->fd);
+	    pInfo->fd = -1;
+	    return FALSE;
+	}
+#ifdef SUNSOFT
+# ifdef XKB
+	else {
+	    /* Probe keyboard settings if not specified in configuration */
+	    char *xkbkeymap = NULL, *xkbmodel = NULL, *xkblayout = NULL;
+	    int i, found;
+	    
+	    const char *kbdDefaults[] = {
+		"Protocol",         "standard",
+		"AutoRepeat",       "500 30",
+		"XkbRules",         "xorg",
+		"XkbModel",         "pc105",
+		"XkbLayout",        "us",
+		"Panix106",         "off",
+		"CustomKeycodes",   "off",
+		NULL, NULL, 	    /* leave room to add XkbKeymap if needed */
+		NULL 		    /* list terminator */
+	    };
+	    
+	    sun_find_xkbnames(priv->ktype, priv->klayout,
+			      &xkbkeymap, &xkbmodel, &xkblayout);
+
+#define SetXkbDefaults(OPTION, VALUE) \
+	if (VALUE != NULL) { \
+	    for (i = 0, found = 0; kbdDefaults[i] != NULL; i += 2) { \
+		if (strcmp(kbdDefaults[i], OPTION) == 0) { \
+		    kbdDefaults[i+1] = VALUE; found++; \
+		    xf86Msg(X_PROBED, "%s: %s = %s\n", priv->devName, \
+			    OPTION, VALUE); \
+		    break; \
+		} \
+	    } \
+	}
+	    
+#define AddXkbDefaults(OPTION, VALUE) \
+	if (VALUE != NULL) { \
+	    for (i = 0; kbdDefaults[i] != NULL; i += 2) \
+	    { /* skip to end */ ; } \
+	    kbdDefaults[i++] = OPTION; \
+	    kbdDefaults[i++] = VALUE; \
+	}
+
+	    SetXkbDefaults("XkbModel", xkbmodel);
+	    SetXkbDefaults("XkbLayout", xkblayout);
+	    AddXkbDefaults("XkbKeymap", xkbkeymap);
+
+	    xf86CollectInputOptions(pInfo, kbdDefaults, NULL);
+	}
+# endif
+#endif
 	pInfo->read_input = ReadInput;
 	return TRUE;
     } else {


--- hw/xfree86/os-support/solaris/sun_kbd.h	2006-10-11 13:46:15.000000000 -0700
+++ hw/xfree86/os-support/sunos/sun_kbd.h	2005-11-21 16:14:25.602187000 -0800
@@ -38,6 +38,7 @@
     int			kbdFD;
     const char *	devName;
     int 		ktype;		/* Keyboard type from KIOCTYPE */
+    int 		klayout;	/* Keyboard layout from KIOCLAYOUT */
     Bool		kbdActive;	/* Have we set kbd modes for X? */
     int 		otranslation;	/* Original translation mode */
     int 		odirect;	/* Original "direct" mode setting */

--- hw/xfree86/os-support/solaris/Makefile.am	2006-10-11 13:46:15.000000000 -0700
+++ hw/xfree86/os-support/solaris/Makefile.am	2006-10-18 10:02:39.962011000 -0700
@@ -4,7 +4,7 @@
 VTSW_SRC = $(srcdir)/../shared/VTsw_usl.c
 else
 IO_SRC   = sun_io.c sun_kbd.h
-KBD_SRCS = sun_kbd.c sun_kbdEv.c sun_kbd.h
+KBD_SRCS = sun_kbd.c sun_kbdEv.c sun_kbd.h sun_xkbtable.c sun_xkbtable.h
 VTSW_SRC = $(srcdir)/../shared/VTsw_noop.c
 endif
 
