From f4111b898ea33d8d5015347f6192fc704dd1381a Mon Sep 17 00:00:00 2001
From: Alan Coopersmith <alan.coopersmith@sun.com>
Date: Thu, 22 Jan 2009 19:46:25 -0800
Subject: [PATCH] Revert "If AEI is on, disable 'vmmouse' in addition to 'kbd' and 'mouse'."

This reverts commit d6129ebf8dad9cfbc13dc8db7c780b023bf9a60b.
---
 hw/xfree86/common/xf86Config.c       |    5 ++---
 hw/xfree86/doc/man/xorg.conf.man.pre |    2 +-
 2 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/hw/xfree86/common/xf86Config.c b/hw/xfree86/common/xf86Config.c
index 6c6fac3..241c19d 100644
--- a/hw/xfree86/common/xf86Config.c
+++ b/hw/xfree86/common/xf86Config.c
@@ -2472,14 +2472,13 @@ checkInput(serverLayoutPtr layout, Bool implicit_layout) {
         while(*dev)
         {
             if (strcmp((*dev)->driver, "kbd") == 0 ||
-                strcmp((*dev)->driver, "mouse") == 0 ||
-                strcmp((*dev)->driver, "vmmouse") == 0)
+                strcmp((*dev)->driver, "mouse") == 0)
             {
                 IDevPtr *current;
                 if (!warned)
                 {
                     xf86Msg(X_WARNING, "AllowEmptyInput is on, devices using "
-                            "drivers 'kbd', 'mouse' or 'vmmouse' will be disabled.\n");
+                            "drivers 'kbd' or 'mouse' will be disabled.\n");
                     warned = TRUE;
                 }
 
diff --git a/hw/xfree86/doc/man/xorg.conf.man.pre b/hw/xfree86/doc/man/xorg.conf.man.pre
index d9a4b35..4f1ba00 100644
--- a/hw/xfree86/doc/man/xorg.conf.man.pre
+++ b/hw/xfree86/doc/man/xorg.conf.man.pre
@@ -662,7 +662,7 @@ the X server to load. Disabled by default.
 If enabled, don't add the standard keyboard and mouse drivers, if there are no
 input devices in the config file.  Enabled by default if AutoAddDevices and
 AutoEnableDevices is enabled, otherwise disabled.
-If AllowEmptyInput is on, devices using the kbd, mouse or vmmouse driver are ignored.
+If AllowEmptyInput is on, devices using the kbd or mouse driver are ignored.
 .TP 7
 .BI "Option \*qAutoAddDevices\*q \*q" boolean \*q
 If this option is disabled, then no devices will be added from HAL events.

-- 
1.5.6.5

From e4d881a4a8ef743361ff62bcb766dd0e8d15c02e Mon Sep 17 00:00:00 2001
From: Alan Coopersmith <alan.coopersmith@sun.com>
Date: Thu, 22 Jan 2009 19:47:11 -0800
Subject: [PATCH] Revert "xfree86: If AEI is on, disable "kbd" and "mouse" devices."

This reverts commit c264826da96ad1859dd112b17eb8aa9e5278478f.
---
 hw/xfree86/common/xf86Config.c       |   39 +--------------------------------
 hw/xfree86/doc/man/xorg.conf.man.pre |    1 -
 2 files changed, 2 insertions(+), 38 deletions(-)

diff --git a/hw/xfree86/common/xf86Config.c b/hw/xfree86/common/xf86Config.c
index 241c19d..5b981e5 100644
--- a/hw/xfree86/common/xf86Config.c
+++ b/hw/xfree86/common/xf86Config.c
@@ -1292,7 +1292,7 @@ checkCoreInputDevices(serverLayoutPtr servlayoutp, Bool implicitLayout)
     }
 
     /* 4. First pointer with 'mouse' as the driver. */
-    if (!foundPointer && !xf86Info.allowEmptyInput) {
+    if (!foundPointer && (!xf86Info.allowEmptyInput || implicitLayout)) {
 	confInput = xf86findInput(CONF_IMPLICIT_POINTER,
 				  xf86configptr->conf_input_lst);
 	if (!confInput) {
@@ -1432,7 +1432,7 @@ checkCoreInputDevices(serverLayoutPtr servlayoutp, Bool implicitLayout)
     }
 
     /* 4. First keyboard with 'keyboard' or 'kbd' as the driver. */
-    if (!foundKeyboard && !xf86Info.allowEmptyInput) {
+    if (!foundKeyboard && (!xf86Info.allowEmptyInput || implicitLayout)) {
 	confInput = xf86findInput(CONF_IMPLICIT_KEYBOARD,
 				  xf86configptr->conf_input_lst);
 	if (!confInput) {
@@ -2460,41 +2460,6 @@ addDefaultModes(MonPtr monitorp)
 static void
 checkInput(serverLayoutPtr layout, Bool implicit_layout) {
     checkCoreInputDevices(layout, implicit_layout);
-
-    /* AllowEmptyInput and the "kbd" and "mouse" drivers are mutually
-     * exclusive. Trawl the list for mouse/kbd devices and disable them.
-     */
-    if (xf86Info.allowEmptyInput && layout->inputs)
-    {
-        IDevPtr *dev = layout->inputs;
-        BOOL warned = FALSE;
-
-        while(*dev)
-        {
-            if (strcmp((*dev)->driver, "kbd") == 0 ||
-                strcmp((*dev)->driver, "mouse") == 0)
-            {
-                IDevPtr *current;
-                if (!warned)
-                {
-                    xf86Msg(X_WARNING, "AllowEmptyInput is on, devices using "
-                            "drivers 'kbd' or 'mouse' will be disabled.\n");
-                    warned = TRUE;
-                }
-
-                xf86Msg(X_WARNING, "Disabling %s\n", (*dev)->identifier);
-
-                current = dev;
-                xfree(*dev);
-
-                do {
-                    *current = *(current + 1);
-                    current++;
-                } while(*current);
-            } else
-                dev++;
-        }
-    }
 }
 
 /*
diff --git a/hw/xfree86/doc/man/xorg.conf.man.pre b/hw/xfree86/doc/man/xorg.conf.man.pre
index 4f1ba00..34339a9 100644
--- a/hw/xfree86/doc/man/xorg.conf.man.pre
+++ b/hw/xfree86/doc/man/xorg.conf.man.pre
@@ -662,7 +662,6 @@ the X server to load. Disabled by default.
 If enabled, don't add the standard keyboard and mouse drivers, if there are no
 input devices in the config file.  Enabled by default if AutoAddDevices and
 AutoEnableDevices is enabled, otherwise disabled.
-If AllowEmptyInput is on, devices using the kbd or mouse driver are ignored.
 .TP 7
 .BI "Option \*qAutoAddDevices\*q \*q" boolean \*q
 If this option is disabled, then no devices will be added from HAL events.

-- 
1.5.6.5
